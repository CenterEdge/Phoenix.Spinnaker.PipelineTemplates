schema: "1"
id: phoenix-production-template
protect: false
configuration:
  concurrentExecutions:
    limitConcurrent: true
    parallel: false
  notifications:
  - address: phoenixdev-ci
    level: pipeline
    message:
      pipeline.failed:
        text: "Pipeline Failure...@channel"
    name: slack0
    type: slack
    when:
    - pipeline.starting
    - pipeline.complete
    - pipeline.failed
variables:
- name: application
  description: The name of the application to scope this pipeline to
- name: loadbalancer
  description: The name of the load balancer for clusters created by this pipeline
- name: clustername
  description: The name of cluster that contains the k8s pods generated by this pipeline
- name: stagingclustername
  description: The name of the staging cluster to pull the image we want to deploy to production
- name: imagenamepattern
  description: A string used to pattern match the name of the image we want to pull from the staging cluster
- name: smoketestjob
  description: Location of the job to execute for running Smoke Tests
- name: stagingloadbalancer
  description: The name of the load balancer for clusters created by this pipeline
- name: stagingclustername
  description: The name of cluster that contains the k8s pods generated by this pipeline
- name: gcrimage
  description: The GCR image of the container to run
- name: gcrrepo
  description: The GCR repository to connect to
- name: podAnnotations
  type: object
  defaultValue: {}
  description: The annotations to assign to pods
- name: product
  description: The name of the product this deployment belongs to
  defaultValue: Phoenix
- name: requestcpu
  description: The amount of CPU requested
  defaultValue: 100m
- name: requestmem
  description: The amount of Memory requested
  defaultValue: 512Mi
- name: maxcpu
  description: The CPU limit for a given pod
  defaultValue: 200m
- name: maxmem
  description: The Memory limit for a pod
  defaultValue: 1024Mi
- name: statsdSampleRate
  description: The percentage of requests to log to statsd. Set to 0 to disable
  defaultValue: 100
- name: sdkversion
  description: The sdk version to use when testing
  defaultValue: "${#stage( 'FindImage' )['context']['amiDetails'][0]['tag']} }"
stages:
- config:
    clusters:
    - account: phoenix
      application: "{{ application }}"
      cloudProvider: kubernetes
      containers:
      - args: []
        command: []
        envVars:
        - name: ASPNETCORE_ENVIRONMENT
          value: Staging
        - name: ASPNETCORE_URLS
          value: http://localhost:8080/
        - envSource:
            secretSource:
              key: key
              secretName: feature-flag-key
          name: LaunchDarklyOptions__SdkKey
        imageDescription:
          account: gcr-phoenix
          fromTrigger: true
          imageId: "{{ gcrimage }}"
          registry: us.gcr.io
          repository: "{{ gcrrepo }}"
        imagePullPolicy: IFNOTPRESENT
        limits: {}
        livenessProbe:
          failureThreshold: 3
          handler:
            execAction:
              commands: []
            httpGetAction:
              path: /health
              port: 80
              uriScheme: HTTP
            tcpSocketAction:
              port: 80
            type: HTTP
          initialDelaySeconds: 5
          periodSeconds: 10
          successThreshold: 1
          timeoutSeconds: 1
        name: "phoenix-177420-phoenix-service-{{ application }}"
        ports:
        - containerPort: 8080
          name: http
          protocol: TCP
        readinessProbe:
          failureThreshold: 3
          handler:
            execAction:
              commands: []
            httpGetAction:
              path: /health?type=ready
              port: 80
              uriScheme: HTTP
            tcpSocketAction:
              port: 80
            type: HTTP
          initialDelaySeconds: 15
          periodSeconds: 5
          successThreshold: 1
          timeoutSeconds: 1
        volumeMounts: []
      - args: []
        command: []
        envVars:
        - name: API_GATEWAY_KEY
          envSource:
            secretSource:
              key: key
              secretName: api-gateway
        - name: STATSD_SERVER
          envSource:
            fieldRef:
              fieldPath: status.hostIP
        - name: STATSD_SAMPLE_RATE
          value: "{{ statsdSampleRate }}"
        - name: SERVICE_NAME
          value: "smoke.{{ application }}"
        imageDescription:
          account: gcr-phoenix
          imageId: us.gcr.io/phoenix-177420/nginx-proxy:8
          registry: us.gcr.io
          repository: phoenix-177420/nginx-proxy
          tag: "8"
        imagePullPolicy: IFNOTPRESENT
        limits: {}
        name: phoenix-177420-nginx-proxy
        ports:
        - containerPort: 80
          name: http
          protocol: TCP
        requests: {}
        volumeMounts: []
      deployment:
        deploymentStrategy:
          rollingUpdate:
            maxSurge: 1
            maxUnavailable: 1
          type: RollingUpdate
        enabled: false
        minReadySeconds: 0
      dnsPolicy: ClusterFirst
      freeFormDetails: api
      interestingHealthProviderNames:
      - KubernetesContainer
      - KubernetesPod
      loadBalancers:
      - "{{ stagingloadbalancer }}"
      namespace: default
      nodeSelector: {}
      podAnnotations: "{{ podAnnotations }}"
      provider: kubernetes
      region: default
      replicaSetAnnotations: {}
      stack: staging
      strategy: ""
      targetSize: 1
      terminationGracePeriodSeconds: 30
      volumeSources: []
    overrideTimeout: true
    stageTimeoutMs: 600000
  id: deploy
  inheritanceControl: {}
  inject: {}
  name: Deploy
  type: deploy
- config:
    waitTime: 30
  dependsOn:
  - deploy
  id: healthchecks-wait
  inheritanceControl: {}
  inject: {}
  name: Wait for ALB Health Checks
  type: wait
- config:
    cloudProvider: kubernetes
    cloudProviderType: kubernetes
    cluster: mashtub-prod-api
    credentials: phoenix
    imageNamePattern: .*mashtub.*
    namespaces:
    - default
    onlyEnabled: true
    selectionStrategy: NEWEST
  dependsOn:
  - healthchecks-wait
  id: phoenix-find-mashtub-production-image
  inheritanceControl: {}
  inject: {}
  name: FindImage
  type: findImage
- config:
    completeOtherBranchesThenFail: false
    continuePipeline: true
    failPipeline: false
    job: "{{ smoketestjob }}"
    master: primary-jenkins
    parameters:
       BASE_URL: "https://api-ingress.phoenix.centeredge.io/v1-staging"
       SDK_VERSION: "{{ sdkversion }}"
  dependsOn:
  - phoenix-find-mashtub-production-image
  id: phoenix-scriptedpipelinetest-smoketest
  inheritanceControl: {}
  inject: {}
  name: Smoke Test
  type: jenkins
  notifications:
    - address: phoenixdev-ci
      level: stage
      message:
        stage.failed:
          text: "Smoke Tests Failed...@channel"
      name: slackSmokeTestsFailed
      type: slack
      when:
      - stage.failed
    sendNotifications: true
- config:
    clusters:
    - account: phoenix
      application: "{{ application }}"
      capacity:
        desired: 2
        max: 9
        min: 2
      cloudProvider: kubernetes
      containers:
      - args: []
        command: []
        envVars:
        - name: ASPNETCORE_ENVIRONMENT
          value: Production
        - name: ASPNETCORE_URLS
          value: http://localhost:8080/
        - envSource:
            secretSource:
              key: key
              secretName: feature-flag-key
          name: LaunchDarklyOptions__SdkKey
        imageDescription:
          account: gcr-phoenix
          fromTrigger: true
          imageId: "{{ gcrimage }}"
          registry: us.gcr.io
          repository: "{{ gcrrepo }}"
        imagePullPolicy: IFNOTPRESENT
        limits:
          cpu: "{{ maxcpu }}"
          memory: "{{ maxmem }}"
        livenessProbe:
          failureThreshold: 3
          handler:
            execAction:
              commands: []
            httpGetAction:
              path: /health
              port: 80
              uriScheme: HTTP
            tcpSocketAction:
              port: 80
            type: HTTP
          initialDelaySeconds: 5
          periodSeconds: 10
          successThreshold: 1
          timeoutSeconds: 1
        name: "phoenix-{{ application }}-image"
        ports:
        - containerPort: 8080
          name: http
          protocol: TCP
        readinessProbe:
          failureThreshold: 3
          handler:
            execAction:
              commands: []
            httpGetAction:
              path: /health?type=ready
              port: 80
              uriScheme: HTTP
            tcpSocketAction:
              port: 80
            type: HTTP
          initialDelaySeconds: 15
          periodSeconds: 10
          successThreshold: 1
          timeoutSeconds: 1
        requests: 
          cpu: "{{ requestcpu }}"
          memory: "{{ requestmem }}"
        volumeMounts: []
      - args: []
        command: []
        envVars:
        - name: STATSD_SERVER
          envSource:
            fieldRef:
              fieldPath: status.hostIP
        - name: STATSD_SAMPLE_RATE
          value: "{{ statsdSampleRate }}"
        - name: SERVICE_NAME
          value: "prod.{{ application }}"
        imageDescription:
          account: gcr-phoenix
          imageId: us.gcr.io/phoenix-177420/nginx-proxy:8
          registry: us.gcr.io
          repository: phoenix-177420/nginx-proxy
          tag: "8"
        imagePullPolicy: IFNOTPRESENT
        limits:
          cpu: "{{ maxcpu }}"
          memory: "{{ maxmem }}"
        name: phoenix-177420-nginx-proxy
        ports:
        - containerPort: 80
          name: http
          protocol: TCP
        requests: 
          cpu: "{{ requestcpu }}"
          memory: "{{ requestmem }}"
        volumeMounts: []
      deployment:
        deploymentStrategy:
          rollingUpdate:
            maxSurge: 1
            maxUnavailable: 1
          type: RollingUpdate
        enabled: false
        minReadySeconds: 0
      dnsPolicy: ClusterFirst
      freeFormDetails: api
      interestingHealthProviderNames:
      - KubernetesContainer
      - KubernetesPod
      loadBalancers:
      - "{{ loadbalancer }}"
      namespace: default
      nodeSelector: {}
      podAnnotations: "{{ podAnnotations }}"
      provider: kubernetes
      region: default
      replicaSetAnnotations: {}
      scalingPolicy:
        cpuUtilization:
          target: 40
      stack: prod
      strategy: ""
      targetSize: 3
      terminationGracePeriodSeconds: 30
      volumeSources: []
    overrideTimeout: true
    stageTimeoutMs: 600000
    stageEnabled:
      expression: "#stage('Smoke Test')['context']['buildInfo']['result']=='SUCCESS'"
      type: expression
  dependsOn:
  - phoenix-scriptedpipelinetest-smoketest
  id: phoenix-production-deploy
  inheritanceControl: {}
  inject: {}
  name: Deploy Production
  type: deploy
- config:
    cloudProvider: kubernetes
    cloudProviderType: kubernetes
    cluster: "{{ clustername }}"
    credentials: phoenix
    interestingHealthProviderNames:
    - KubernetesService
    namespaces:
    - default
    preferLargerOverNewer: "false"
    remainingEnabledServerGroups: 1
  dependsOn:
  - phoenix-production-deploy
  id: phoenix-production-disablecluster
  inheritanceControl: {}
  inject: {}
  name: Disable Cluster
  type: disableCluster
- config:
    allowDeleteActive: false
    cloudProvider: kubernetes
    cloudProviderType: kubernetes
    cluster: "{{ clustername }}"
    credentials: phoenix
    namespaces:
    - default
    retainLargerOverNewer: "false"
    shrinkToSize: 2
  dependsOn:
  - phoenix-production-disablecluster
  id: phoenix-production-shrinkcluster
  inheritanceControl: {}
  inject: {}
  name: Shrink Cluster
  type: shrinkCluster
- config:
    cloudProvider: kubernetes
    cloudProviderType: kubernetes
    cluster: "{{ stagingclustername }}"
    clusters: []
    credentials: phoenix
    interestingHealthProviderNames:
    - KubernetesService
    namespaces:
    - default
    target: current_asg_dynamic
  dependsOn:
  - phoenix-production-deploy
  id: destroy-staging-server-group
  inheritanceControl: {}
  inject: {}
  name: Destroy Staging Server Group
  type: destroyServerGroup
- config:
    alias: preconfiguredWebhook
    parameterValues:
      alertType: info
      environment: "{{ clustername }}"
      product: "{{ product }}"
      text: "Start Deploy of {{ application }} to {{ clustername }}"
      title: "Start Deploy of {{ application }} to {{ clustername }}"
    statusUrlResolution: getMethod
  dependsOn:
  - phoenix-scriptedpipelinetest-smoketest
  id: pipelineevent-start-deployment
  inheritanceControl: {}
  inject: {}
  name: Publish Start Event
  type: datadogEvent
- config:
    alias: preconfiguredWebhook
    parameterValues:
      alertType: success
      environment: "{{ clustername }}"
      product: "{{ product }}"
      text: "Deployed image {{ gcrimage }} of {{ application }} to {{ clustername }} 'Deploy Duration:' ${new java.text.SimpleDateFormat('HH:mm:ss').format(#stage('Deploy Production').endTime - execution['startTime'])}"
      title: "Deployed {{ application }} to {{ clustername }}"
    stageEnabled:
      expression: "#stage('Deploy Production').status.toString() == 'SUCCEEDED'"
      type: expression
    statusUrlResolution: getMethod
  dependsOn:
  - phoenix-production-deploy
  id: pipelineevent-success
  inheritanceControl: {}
  inject: {}
  name: Publish Success Event
  type: datadogEvent
- config:
    alias: preconfiguredWebhook
    failOnFailedExpressions: true
    parameterValues:
      alertType: error
      environment: "{{ clustername }}"
      product: "{{ product }}"
      text: "Failed to deploy image {{ gcrimage }} of {{ application }} to {{ clustername }} 'Deploy Duration:' ${new java.text.SimpleDateFormat('HH:mm:ss').format(#stage('Deploy Production').endTime - execution['startTime'])}"
      title: "Failed to deploy {{ application }} to {{ clustername }}"
    stageEnabled:
      expression: "#stage('Deploy Production').status.toString() != 'SUCCEEDED'"
      type: expression
    statusUrlResolution: getMethod
  dependsOn:
  - phoenix-production-deploy
  id: pipelineevent-failed
  inheritanceControl: {}
  inject: {}
  name: Publish Failed Event
  type: datadogEvent
